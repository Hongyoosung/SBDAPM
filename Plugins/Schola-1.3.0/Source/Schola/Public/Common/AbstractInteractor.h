// Copyright (c) 2024 Advanced Micro Devices, Inc. All Rights Reserved.

#pragma once

#include "CoreMinimal.h"
#include "Components/ActorComponent.h"
#include "BehaviorTree/BTTaskNode.h"
#include "BehaviorTree/ValueOrBBKey.h"
#include "AIController.h"
#include "AbstractInteractor.generated.h"

/**
 * @brief An abstract class objects that can interact with the environment, either by observing or acting
 */
UCLASS(Abstract, EditInlineNew)
class SCHOLA_API UAbstractInteractor : public UObject
{
	GENERATED_BODY()

protected:

	virtual FString GenerateId() const;

public:

	/** Replace the Autogenerated ID from GenerateID with the String ID here */
	UPROPERTY(BlueprintReadWrite, EditAnywhere, meta=(InlineEditConditionToggle), Category="Interactor Properties")
	bool bUseCustomId = false;

	/** Replace the Autogenerated ID from GenerateID with the String ID here */
	UPROPERTY(BlueprintReadWrite, EditAnywhere, meta=(EditCondition="bUseCustomId"), Category="Interactor Properties")
	FString CustomId = FString();
	
	/**
	 * @brief Try and Get the Actor this Observer is attached to, may return nullptr
	 * @return the Agent this Observer is attached to in, may return nullptr
	 */
	UFUNCTION(BlueprintCallable, Category = "Interactor Utilities")
	AActor* TryGetOwner() const;

	/**
	 * @brief Get an non-unique label of this Interactor, based on the class of the object containing the interactor
	 * @return the collected ID
	 */
	UFUNCTION(BlueprintCallable, Category = "Interactor Utilities")
	FString GetLabel() const;

	/**
	 * @brief Get the label of this Interactor
	 * @return the collected ID
	 */
	UFUNCTION(BlueprintCallable, Category = "Interactor Utilities")
	virtual FString GetId() const;
	
	/**
	 * @brief Get the label of this Interactor, sanitized to remove characters that can cause issues (e.g. '.'
	 * @return The ID with invalid characters replaced or removed
	*/
	UFUNCTION(BlueprintCallable, Category = "Interactor Utilities")
	virtual FString GetSanitizedId() const;
	
	/**
	 * @brief Get an Outer for this object that is unique w.r.t the agent for getting the ID.
	 * @return a UObject ptr to an owning object in the heirarchy
	 * @note If the UObject is inside a Controller returns the controller. If the UObject is inside a Component return the owner of the component.
	 */
	UFUNCTION(BlueprintCallable, Category = "Interactor Utilities")
	UObject* GetLocation() const;

	/**
	 * @brief Internal function called when an episode ends, Does any preparation required for the next episode.
	 */
	virtual void Reset() PURE_VIRTUAL(UAbstractInteractor::Reset, return;);


#if WITH_EDITORONLY_DATA
	/** A DebugId for this Interactor, to check what will be used for Naming */
	UPROPERTY(VisibleAnywhere, Transient, BlueprintReadOnly, Category = "Interactor Utilities")
	FString DisplayId = FString();
#endif

#if WITH_EDITOR
	/** Generate a DebugId for this Interactor, to check what will be used for Naming */
	UFUNCTION(CallInEditor, Category = "Interactor Utilities")
	void GenerateDebugId()
	{
		this->DisplayId = this->GetId();
	}
#endif
};